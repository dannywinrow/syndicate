<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lotto Syndicate Viewer</title>
<style>
  body{font-family:system-ui,sans-serif;margin:20px;}
  h1{font-size:22px;margin-bottom:4px;}
  #winningNumbers{text-align:center;margin:20px 0;}
  .num{display:inline-block;width:36px;height:36px;line-height:36px;border-radius:50%;background:#eee;text-align:center;margin:3px;font-size:16px;}
  .match{background:#ffeb3b;}
  .bonus{background:#ff5722;color:#fff;}
  table{border-collapse:collapse;margin-top:15px;width:100%;}
  th,td{border:1px solid #ccc;padding:6px;text-align:center;}
  #summary{margin-top:20px;}
  .note{color:#c00;font-size:13px;text-align:center;margin-top:6px;}
</style>
</head>
<body>
<h1>Lotto Syndicate – Viewer Page</h1>
<p style="color:#666;font-size:12px;">Version 0.3.4 – 2025-09-14</p>

<div id="winningNumbers"></div>
<div id="rolldownNote" class="note"></div>

<table id="ticketTable">
  <thead><tr><th>Numbers</th></tr></thead>
  <tbody></tbody>
</table>

<div id="summary"></div>

<script>
// --- default prize tiers ---
const defaultPrizes = {2:0,3:30,4:140,5:1750,"5b":1000000,6:7500000};

// --- read query params ---
const params=new URLSearchParams(location.search);
let currentDraw=null, bonus=null, prizes={...defaultPrizes};
if(params.has('draw')){
  const arr=params.get('draw').split(/[ ,]+/).map(x=>parseInt(x,10));
  if(arr.length>=6){ currentDraw=arr.slice(0,6); bonus=arr[6]; }
}
if(params.has('p')){
  prizes={};
  params.get('p').split(';').forEach(p=>{
    const [k,v]=p.split(':'); prizes[k]=parseInt(v,10);
  });
}

// --- display winning numbers ---
function renderWinningNumbers(){
  if(!currentDraw) return;
  const container=document.getElementById('winningNumbers');
  const dateTxt=params.get('date')||'Selected Draw';
  let html=`<h2>${dateTxt} – Winning Numbers</h2>`;
  currentDraw.forEach(n=>{
    html+=`<span class="num">${String(n).padStart(2,'0')}</span>`;
  });
  if(bonus){
    html+=`<span class="num bonus">${String(bonus).padStart(2,'0')}</span>`;
  }
  container.innerHTML=html;

  // rolldown note if prizes differ
  let rolldown=false;
  for(const k in defaultPrizes){
    if(prizes[k]!==defaultPrizes[k]){ rolldown=true; break; }
  }
  document.getElementById('rolldownNote').textContent=rolldown?
    "Custom prizes applied – likely a rolldown draw.":"";
}
renderWinningNumbers();

// --- ticket decoding ---
function base64UrlDecode(str){
  str=str.replace(/-/g,'+').replace(/_/g,'/');
  while(str.length%4) str+='=';
  return Uint8Array.from(atob(str),c=>c.charCodeAt(0));
}
function decodeCompactTickets(compact){
  const bytes=base64UrlDecode(compact);
  const bits=[]; bytes.forEach(b=>{for(let i=7;i>=0;i--) bits.push((b>>i)&1);});
  let idx=0; function readBits(n){let v=0; for(let i=0;i<n;i++){v=(v<<1)|bits[idx++];} return v;}
  const count=readBits(16);
  const lines=[];
  for(let i=0;i<count;i++){
    const row=[]; for(let j=0;j<6;j++) row.push(readBits(6)+1);
    lines.push(row);
  }
  return lines;
}

let tickets=[];
if(params.has('t')){
  tickets=decodeCompactTickets(params.get('t'));
}

// --- render table ---
function renderTicketTable(){
  const tb=document.querySelector('#ticketTable tbody');
  tb.innerHTML='';
  let totals={};
  tickets.forEach((line,i)=>{
    const tr=document.createElement('tr');
    let html='';
    let count=0, hasBonus=false;
    line.forEach(n=>{
      const matched=currentDraw && currentDraw.includes(n);
      const isBonus=(bonus && n===bonus);
      if(matched||isBonus) count++;
      html+=`<span class="num${matched?' match':''}${isBonus?' bonus':''}">${String(n).padStart(2,'0')}</span>`;
    });
    tr.innerHTML=`<td>${html}</td>`;
    tb.appendChild(tr);

    // categorize win
    let cat=null;
    if(count>=2){
      if(count===5 && bonus && line.includes(bonus)) cat='5b';
      else cat=String(count);
      totals[cat]=(totals[cat]||0)+1;
    }
  });

  // summary
  let sumHtml='<h3>Summary</h3><table><thead><tr><th>Matches</th><th>Count</th><th>Prize</th><th>Total</th></tr></thead><tbody>';
  let grand=0;
  for(const k of Object.keys(prizes)){
    if(totals[k]){
      const prize=prizes[k];
      const count=totals[k];
      const total=prize*count;
      grand+=total;
      sumHtml+=`<tr><td>${k}</td><td>${count}</td><td>£${prize.toLocaleString()}</td><td>£${total.toLocaleString()}</td></tr>`;
    }
  }
  sumHtml+=`<tr><td colspan="3"><b>Total Winnings</b></td><td><b>£${grand.toLocaleString()}</b></td></tr>`;
  sumHtml+='</tbody></table>';
  document.getElementById('summary').innerHTML=sumHtml;
}
renderTicketTable();
</script>
</body>
</html>
