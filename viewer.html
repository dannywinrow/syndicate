<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Syndicate Lotto Checker</title>
<style>
  body{font-family:system-ui, sans-serif; margin:20px;}
  h1{font-size:20px;}
  .ticket-grid{border-collapse:collapse;width:100%;margin-top:10px;}
  .ticket-grid th,.ticket-grid td{border:1px solid #ccc;padding:6px;text-align:center;vertical-align:middle;}
  .num{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:34px;height:34px;
    border-radius:50%;
    border:1px solid #ddd;
    margin:2px;font-weight:600;
  }
  .matchMain{background:#ffeb3b}
  .matchBonus{background:#f44336;color:#fff}
  .matchBonusDim{background:rgba(244,67,54,0.12);color:#000}
  .drawnum{background:#1976d2;color:#fff;font-weight:bold}
  .bonus{background:#d32f2f;color:#fff;font-weight:bold}
  .lineNo{
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    font-size:10px;
    color:#666;
    width:16px;
  }
  #winningDisplay{margin:20px 0;text-align:center;}
  #winningDisplay h2{margin-bottom:6px;}
  #winningDisplay .drawDate{color:#666;font-size:14px;margin:-4px 0 12px;}
  #winningNums{display:flex;justify-content:center;flex-wrap:wrap;}
  #summary{margin:15px 0;font-weight:bold}
  #summaryTable{border-collapse:collapse;margin-bottom:15px;width:100%;}
  #summaryTable th,#summaryTable td{border:1px solid #ccc;padding:4px 8px;text-align:center;}
  #totalWinnings{margin-top:10px;font-size:16px;font-weight:bold}
  #sortControls{margin:10px 0;}
  button{padding:6px 10px;margin:2px;border:1px solid #ccc;border-radius:6px;cursor:pointer;background:#fafafa;}
  @media(max-width:640px){
    .num{width:28px;height:28px;line-height:28px;font-size:13px;margin:1px;}
    td,th{font-size:12px;padding:3px}
    h1{font-size:18px;}
    .lineNo{font-size:8px;}
  }
</style>
</head>
<body>
<h1>Syndicate Lotto Checker</h1>
<p style="color:#666;font-size:12px;">Version 0.4.6 – 2025-09-14</p>

<div id="winningDisplay"></div>
<div id="summary"></div>
<table id="summaryTable"></table>
<div id="totalWinnings"></div>

<div id="sortControls">
  <button id="toggleSort">Sort by Ticket/Line</button>
</div>

<table class="ticket-grid" id="ticketTable">
  <thead>
    <tr><th>Line</th><th>Numbers</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// --- Helpers ---
function base64UrlDecode(str){
  str=str.replace(/-/g,'+').replace(/_/g,'/');
  const pad=str.length%4 ? 4-(str.length%4) : 0;
  if(pad) str+='='.repeat(pad);
  const bin=atob(str);
  return Uint8Array.from(bin,c=>c.charCodeAt(0));
}
function decodeCompactTickets(t){
  const bytes=base64UrlDecode(t);
  let bitpos=0;
  function getBits(n){
    let val=0;
    for(let i=0;i<n;i++){
      const byte=bytes[Math.floor(bitpos/8)];
      const bit=7-(bitpos%8);
      val=(val<<1)|((byte>>bit)&1);
      bitpos++;
    }
    return val;
  }
  const lineCount=getBits(16);
  const lines=[];
  for(let i=0;i<lineCount;i++){
    const arr=[];
    for(let j=0;j<6;j++) arr.push(getBits(6)+1);
    lines.push(arr);
  }
  return [{id:1,lines}];
}
function parseTickets(str){
  if(!str) return [];
  return str.split(";").filter(x=>x && x!=="0").map((chunk,idx)=>{
    const nums=(chunk.split("-")[2]||"");
    const lines=[];
    for(let i=0;i+12<=nums.length;i+=12){
      const row=[];
      for(let j=0;j<12;j+=2){
        row.push(parseInt(nums.slice(i+j,i+j+2),10));
      }
      lines.push(row);
    });
    return {id:idx+1,lines};
  });
}

// --- Prize tables ---
let prizeTable={
  0:{label:"0",prize:"-",value:0},
  1:{label:"1",prize:"-",value:0},
  2:{label:"2",prize:"Lucky Dip",value:0},
  3:{label:"3",prize:"£30",value:30},
  4:{label:"4",prize:"£140",value:140},
  5:{label:"5",prize:"£1,750",value:1750},
  "5+Bonus":{label:"5 + Bonus",prize:"£1,000,000",value:1000000},
  6:{label:"6",prize:"Jackpot!",value:null}
};
function parseCustomPrizes(p){
  const out={...prizeTable};
  p.split(";").forEach(entry=>{
    const [cat,val]=entry.split(":");
    if(!cat||!val) return;
    let key=cat==="5b"?"5+Bonus":cat;
    if(key==2){
      out[key]={label:"2",prize:"Lucky Dip + £"+parseInt(val,10).toLocaleString(),value:parseInt(val,10)};
    } else {
      out[key]={label:key,prize:"£"+parseInt(val,10).toLocaleString(),value:parseInt(val,10)};
    }
  });
  return out;
}

// --- Label helper ---
function lineLabel(ticketId, lineNo, totalTickets){
  const letters=["A","B","C","D","E","F","G"];
  const linePart=(lineNo<=7 ? letters[lineNo-1] : String(lineNo));
  if(totalTickets===1) return linePart;
  return `${ticketId}:${linePart}`;
}

// --- Main rendering logic ---
let lastResults=[], sortMode="matches", mainNums=[], bonus=null;

function renderResults(tickets,mainNums,bonus){
  const results=[];

  tickets.forEach(t=>{
    t.lines.forEach((line,i)=>{
      let count=0, hasBonus=false;
      line.forEach(n=>{
        if(mainNums.includes(n)) count++;
        if(n===bonus) hasBonus=true;
      });
      let category=count;
      if(count===5 && hasBonus) category="5+Bonus";
      results.push({ticketId:t.id,lineNo:i+1,numbers:line,matchCount:count,hasBonus,category});
    });
  });

  lastResults=results;
  renderTable();
  summarize(results.map(r=>r.category));
}

function renderTable(){
  const tbody=document.querySelector("#ticketTable tbody");
  tbody.innerHTML="";
  let results=[...lastResults];

  if(sortMode==="matches"){
    const rankMap = {6:8,"5+Bonus":7,5:6,4:5,3:4,2:3,1:2,0:1};
    results.sort((a,b)=>{
      const ra=rankMap[a.category]??1, rb=rankMap[b.category]??1;
      if(rb!==ra) return rb-ra;
      if(a.ticketId!==b.ticketId) return a.ticketId-b.ticketId;
      return a.lineNo-b.lineNo;
    });
  } else {
    results.sort((a,b)=>{
      if(a.ticketId!==b.ticketId) return a.ticketId-b.ticketId;
      return a.lineNo-b.lineNo;
    });
  }

  results.forEach(r=>{
    const tr=document.createElement("tr");

    // Line number cell
    const tdLine=document.createElement("td");
    tdLine.className="lineNo";
    tdLine.textContent=lineLabel(r.ticketId, r.lineNo, lastResults.reduce((max,t)=>Math.max(max,t.ticketId),1));
    tr.appendChild(tdLine);

    // Numbers cell
    const tdNums=document.createElement("td");
    r.numbers.forEach(n=>{
      const s=document.createElement("span");
      s.className="num";
      if(mainNums.includes(n)) s.classList.add("matchMain");
      if(n===bonus){
        if(r.category==="5+Bonus"){
          s.classList.add("matchBonus");
        } else {
          s.classList.add("matchBonusDim");
        }
      }
      s.textContent=String(n).padStart(2,"0");
      tdNums.appendChild(s);
    });
    tr.appendChild(tdNums);

    tbody.appendChild(tr);
  });
}

function summarize(results){
  const counts={}; results.forEach(c=>counts[c]=(counts[c]||0)+1);
  const summaryTable=document.getElementById("summaryTable");
  summaryTable.innerHTML="";
  const thead=document.createElement("thead");
  thead.innerHTML="<tr><th>Matches</th><th>Line count</th><th>Prize</th><th>Total value</th></tr>";
  const tb=document.createElement("tbody");
  let cashTotal=0, freeTickets=0, sumCount=0;
  const order=[0,1,2,3,4,5,"5+Bonus",6];
  order.forEach(cat=>{
    const c=counts[cat]||0; sumCount+=c;
    const info=prizeTable[cat];
    if(!info) return;
    let prizeLabel=info.prize;
    let val=info.value;
    if(cat==2){
      prizeLabel="Lucky Dip";
      if(val>0){ prizeLabel+=" + £"+val.toLocaleString(); }
    }
    if(typeof val==="number" && val>0 && cat!=2){
      prizeLabel="£"+val.toLocaleString();
    }
    let totalVal="-";
    if(val!==null){
      if(val>0){ totalVal="£"+(val*c).toLocaleString(); cashTotal+=val*c; }
      else if(cat==2){ freeTickets+=c; }
    }
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${info.label||cat}</td><td>${c}</td><td>${prizeLabel}</td><td>${totalVal}</td>`;
    tb.appendChild(tr);
  });
  const tr=document.createElement("tr");
  tr.innerHTML=`<td><b>Total</b></td><td><b>${sumCount}</b></td><td></td><td><b>£${cashTotal.toLocaleString()}</b></td>`;
  tb.appendChild(tr);
  summaryTable.appendChild(thead); summaryTable.appendChild(tb);
  let totalText="Total winnings: ";
  if(cashTotal>0) totalText+="£"+cashTotal.toLocaleString();
  if(freeTickets>0) totalText+=(cashTotal>0?" and ":"")+freeTickets+" Free Ticket(s)";
  if(cashTotal===0 && freeTickets===0) totalText+="None";
  document.getElementById("totalWinnings").textContent=totalText;
}

// --- Main ---
const params=new URLSearchParams(location.search);
let tickets=[];
if(params.get("t")) tickets=decodeCompactTickets(params.get("t"));
else if(params.get("tickets")) tickets=parseTickets(params.get("tickets"));

if(params.get("p")) prizeTable=parseCustomPrizes(params.get("p"));

const draw=params.get("draw");
if(draw){
  const arr=draw.split(/[ ,]+/).map(x=>parseInt(x,10));
  if(arr.length>=6){
    mainNums=arr.slice(0,6); bonus=(arr.length>=7?arr[6]:null);
    const disp=document.getElementById("winningDisplay");
    disp.innerHTML="";
    const heading=document.createElement("h2");
    heading.textContent="Winning Numbers";
    disp.appendChild(heading);
    if(params.get("date")){
      const dateP=document.createElement("p");
      dateP.className="drawDate";
      dateP.textContent="Draw Date: "+params.get("date");
      disp.appendChild(dateP);
    }
    const numsDiv=document.createElement("div");
    numsDiv.id="winningNums";
    mainNums.forEach(n=>{
      const s=document.createElement("span");
      s.className="num drawnum";
      s.textContent=String(n).padStart(2,"0");
      numsDiv.appendChild(s);
    });
    if(bonus){
      const b=document.createElement("span");
      b.className="num bonus";
      b.textContent=String(bonus).padStart(2,"0");
      numsDiv.appendChild(b);
    }
    disp.appendChild(numsDiv);
    renderResults(tickets,mainNums,bonus);
  }
}

// Toggle sort mode
document.getElementById("toggleSort").addEventListener("click",()=>{
  if(sortMode==="matches"){ sortMode="ticket"; document.getElementById("toggleSort").textContent="Sort by Matches"; }
  else { sortMode="matches"; document.getElementById("toggleSort").textContent="Sort by Ticket/Line"; }
  renderTable();
});
</script>
</body>
</html>
