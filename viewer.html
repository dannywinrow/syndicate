<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Syndicate Lotto Checker</title>
<style>
  body{font-family:system-ui, sans-serif; margin:20px;}
  h1{font-size:20px;}
  .ticket-grid{border-collapse:collapse;width:100%;margin-top:10px;}
  .ticket-grid th,.ticket-grid td{border:1px solid #ccc;padding:6px;text-align:center;vertical-align:middle;}
  .num{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:34px;height:34px;
    border-radius:50%;
    border:1px solid #ddd;
    margin:2px;font-weight:600;
  }
  .num input{
    width:100%;height:100%;
    border:none;outline:0;text-align:center;
    font-weight:700;background:transparent;
    font-size:14px;
  }
  .matchMain{background:#ffeb3b}
  .matchBonus{background:#f44336;color:#fff}
  .matchBonusDim{background:rgba(244,67,54,0.12);color:#000}
  .drawnum{background:#1976d2;color:#fff;font-weight:bold}
  .bonus{background:#d32f2f;color:#fff;font-weight:bold}
  .lineNo{
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    font-size:10px;
    color:#666;
    width:16px;
  }
  #winningDisplay{margin:20px 0;text-align:center;}
  #winningDisplay h2{margin-bottom:6px;}
  #winningDisplay .drawDate{color:#666;font-size:14px;margin:-4px 0 12px;}
  #winningNums{display:flex;justify-content:center;flex-wrap:wrap;gap:2px;}
  #winningActions{margin-top:8px}
  #summary{margin:15px 0;font-weight:bold;display:none}
  #summaryTable{border-collapse:collapse;margin-bottom:15px;width:100%;display:none}
  #summaryTable th,#summaryTable td{border:1px solid #ccc;padding:4px 8px;text-align:center;}
  #totalWinnings{margin-top:10px;font-size:16px;font-weight:bold;display:none}
  #sortControls{margin:10px 0;display:none}
  button{padding:6px 10px;margin:2px;border:1px solid #ccc;border-radius:6px;cursor:pointer;background:#fafafa;}
  .hint{color:#666;font-size:12px;margin-top:6px}
  @media(max-width:640px){
    .num{width:28px;height:28px;line-height:28px;font-size:13px;margin:1px;}
    td,th{font-size:12px;padding:3px}
    h1{font-size:18px;}
    .lineNo{font-size:8px;}
  }
</style>
</head>
<body>
<h1>Syndicate Lotto Checker</h1>
<p style="color:#666;font-size:12px;">Version 0.4.9 – 2025-09-14</p>

<div id="winningDisplay"></div>

<div id="summary"></div>
<table id="summaryTable"></table>
<div id="totalWinnings"></div>

<div id="sortControls">
  <button id="toggleSort">Sort by Ticket/Line</button>
</div>

<table class="ticket-grid" id="ticketTable">
  <thead>
    <tr><th>Line</th><th>Numbers</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ---------------- Helpers ----------------
function base64UrlDecode(str){
  str=str.replace(/-/g,'+').replace(/_/g,'/');
  const pad=str.length%4 ? 4-(str.length%4) : 0;
  if(pad) str+='='.repeat(pad);
  const bin=atob(str);
  return Uint8Array.from(bin,c=>c.charCodeAt(0));
}

function decodeCompactTickets(t){
  const bytes=base64UrlDecode(t);
  let bitpos=0;
  function getBits(n){
    let val=0;
    for(let i=0;i<n;i++){
      const byte=bytes[Math.floor(bitpos/8)];
      const bit=7-(bitpos%8);
      val=(val<<1)|((byte>>bit)&1);
      bitpos++;
    }
    return val;
  }
  const lineCount=getBits(16);
  const lines=[];
  for(let i=0;i<lineCount;i++){
    const arr=[];
    for(let j=0;j<6;j++) arr.push(getBits(6)+1);
    lines.push(arr);
  }
  return [{id:1,lines}];
}

function parseTickets(str){
  if(!str) return [];
  return str.split(";").filter(x=>x && x!=="0").map((chunk,idx)=>{
    const nums=(chunk.split("-")[2]||"");
    const lines=[];
    for(let i=0;i+12<=nums.length;i+=12){
      const row=[];
      for(let j=0;j<12;j+=2){
        row.push(parseInt(nums.slice(i+j,i+j+2),10));
      }
      lines.push(row);
    }
    return {id:idx+1,lines};
  });
}

// ---------------- Prize tables ----------------
let prizeTable={
  0:{label:"0",prize:"-",value:0},
  1:{label:"1",prize:"-",value:0},
  2:{label:"2",prize:"Lucky Dip",value:0},
  3:{label:"3",prize:"£30",value:30},
  4:{label:"4",prize:"£140",value:140},
  5:{label:"5",prize:"£1,750",value:1750},
  "5+Bonus":{label:"5 + Bonus",prize:"£1,000,000",value:1000000},
  6:{label:"6",prize:"Jackpot!",value:null}
};

function parseCustomPrizes(p){
  const out={...prizeTable};
  p.split(";").forEach(entry=>{
    const [cat,val]=entry.split(":");
    if(!cat||!val) return;
    let key=cat==="5b"?"5+Bonus":cat;
    if(key==2){
      out[key]={label:"2",prize:"Lucky Dip + £"+parseInt(val,10).toLocaleString(),value:parseInt(val,10)};
    } else {
      out[key]={label:key,prize:"£"+parseInt(val,10).toLocaleString(),value:parseInt(val,10)};
    }
  });
  return out;
}

// ---------------- Label helper ----------------
function lineLabel(ticketId, lineNo, totalTickets){
  const letters=["A","B","C","D","E","F","G"];
  const linePart=(lineNo<=7 ? letters[lineNo-1] : String(lineNo));
  if(totalTickets===1) return linePart;
  return `${ticketId}:${linePart}`;
}

// ---------------- Date helpers ----------------
function formatDate(str){
  const isoMatch = /^(\d{4})-(\d{2})-(\d{2})$/.exec(str);
  if(isoMatch){
    const [_,y,m,d] = isoMatch;
    const dt = new Date(`${y}-${m}-${d}T00:00:00Z`);
    return dt.toLocaleDateString("en-GB", {
      weekday:"short", day:"2-digit", month:"short", year:"numeric"
    });
  }
  return str;
}

function autoDateFromF(ticketsParam){
  const fMatch = ticketsParam.match(/F(\d{3,4})/i);
  if(!fMatch) return null;
  const fVal = parseInt(fMatch[1],10);
  const anchorF = 3102;
  const anchorDate = new Date(Date.UTC(2025,8,13)); // 13 Sep 2025
  const diff = fVal - anchorF;
  const daysOffset = diff * 3.5; // 2 draws/week
  const estDate = new Date(anchorDate.getTime() + daysOffset*86400000);
  return estDate.toISOString().slice(0,10);
}

// ---------------- State ----------------
const params=new URLSearchParams(location.search);
let tickets=[];
let autoDate=null;
if(params.get("t")){
  tickets=decodeCompactTickets(params.get("t"));
}else if(params.get("tickets")){
  const raw=params.get("tickets");
  tickets=parseTickets(raw);
  autoDate=autoDateFromF(raw);
}
if(params.get("p")) prizeTable=parseCustomPrizes(params.get("p"));

let lastResults=[];
let sortMode="matches";
let mainNums=[];   // empty until user applies
let bonus=null;

// ---------------- Rendering ----------------
function buildWinningTop(drawProvided){
  const disp=document.getElementById("winningDisplay");
  disp.innerHTML="";

  const heading=document.createElement("h2");
  heading.textContent="Winning Numbers";
  disp.appendChild(heading);

  // date line (from &date or inferred F####)
  const dateText = params.get("date") || (drawProvided ? (params.get("tickets") ? autoDate : null) : (params.get("tickets") ? autoDate : null));
  if(dateText){
    const dateP=document.createElement("p");
    dateP.className="drawDate";
    dateP.textContent="Draw Date: "+formatDate(dateText);
    disp.appendChild(dateP);
  }

  const numsDiv=document.createElement("div");
  numsDiv.id="winningNums";

  if(drawProvided){
    // Show fixed balls
    mainNums.forEach(n=>{
      const s=document.createElement("span");
      s.className="num drawnum";
      s.textContent=String(n).padStart(2,"0");
      numsDiv.appendChild(s);
    });
    if(bonus!=null){
      const b=document.createElement("span");
      b.className="num bonus";
      b.textContent=String(bonus).padStart(2,"0");
      numsDiv.appendChild(b);
    }
  }else{
    // Show 6+1 input "balls"
    for(let i=0;i<6;i++){
      const wrap=document.createElement("span");
      wrap.className="num";
      const inp=document.createElement("input");
      inp.type="text";
      inp.inputMode="numeric";
      inp.placeholder="--";
      inp.maxLength=2;
      inp.dataset.kind="main";
      inp.addEventListener("input",e=>{
        // keep digits only, clamp 1..59
        e.target.value=e.target.value.replace(/\D/g,"").slice(0,2);
        const v=e.target.value;
        if(v.length===2){
          const n=parseInt(v,10);
          if(n<1 || n>59){ e.target.value=""; return; }
          // auto-advance
          const next = e.target.closest("#winningNums").querySelectorAll("input")[i+1];
          if(next) next.focus();
        }
      });
      wrap.appendChild(inp);
      numsDiv.appendChild(wrap);
    }
    const wrapB=document.createElement("span");
    wrapB.className="num";
    const inpB=document.createElement("input");
    inpB.type="text";
    inpB.inputMode="numeric";
    inpB.placeholder="BB";
    inpB.maxLength=2;
    inpB.dataset.kind="bonus";
    inpB.addEventListener("input",e=>{
      e.target.value=e.target.value.replace(/\D/g,"").slice(0,2);
      const v=e.target.value;
      if(v.length===2){
        const n=parseInt(v,10);
        if(n<1 || n>59){ e.target.value=""; return; }
      }
    });
    wrapB.appendChild(inpB);
    numsDiv.appendChild(wrapB);

    const actions=document.createElement("div");
    actions.id="winningActions";
    const applyBtn=document.createElement("button");
    applyBtn.textContent="Apply numbers";
    applyBtn.addEventListener("click",()=>{
      const inputs=[...numsDiv.querySelectorAll('input[data-kind="main"]')];
      const mains=inputs.map(i=>i.value.trim()).filter(Boolean).map(x=>parseInt(x,10));
      if(mains.length<6){ alert("Please enter 6 main numbers (1–59)."); return; }
      const bonusInp=numsDiv.querySelector('input[data-kind="bonus"]');
      const bVal=bonusInp.value.trim(); // optional
      if(mains.some(n=>n<1||n>59||Number.isNaN(n))){ alert("Main numbers must be between 1 and 59."); return; }
      if(bVal && (parseInt(bVal,10)<1 || parseInt(bVal,10)>59)){ alert("Bonus must be 1–59."); return; }
      mainNums=mains.slice(0,6);
      bonus=bVal?parseInt(bVal,10):null;
      // re-render top as fixed balls and show results
      buildWinningTop(true);
      renderResultsAndSummary();
    });
    actions.appendChild(applyBtn);

    const hint=document.createElement("div");
    hint.className="hint";
    hint.textContent="Type 6 main numbers and an optional bonus, then press Apply.";
    actions.appendChild(hint);

    disp.appendChild(numsDiv);
    disp.appendChild(actions);
    return; // don't render fixed balls now
  }

  disp.appendChild(numsDiv);
}

function renderResultsAndSummary(){
  // show sort & summary sections
  document.getElementById("sortControls").style.display="";
  document.getElementById("summary").style.display="";
  document.getElementById("summaryTable").style.display="";
  document.getElementById("totalWinnings").style.display="";

  // compute results then render
  const results=[];
  tickets.forEach(t=>{
    t.lines.forEach((line,i)=>{
      let count=0, hasBonus=false;
      line.forEach(n=>{
        if(mainNums.includes(n)) count++;
        if(bonus!=null && n===bonus) hasBonus=true;
      });
      let category=count;
      if(count===5 && hasBonus) category="5+Bonus";
      results.push({ticketId:t.id,lineNo:i+1,numbers:line,matchCount:count,hasBonus,category});
    });
  });
  lastResults=results;
  renderTable();            // with highlighting
  summarize(results.map(r=>r.category));
}

function renderTable(){
  const tbody=document.querySelector("#ticketTable tbody");
  tbody.innerHTML="";
  const totalTickets = tickets.length;

  let results;
  if(lastResults.length){
    results=[...lastResults];
    if(sortMode==="matches"){
      const rankMap = {6:8,"5+Bonus":7,5:6,4:5,3:4,2:3,1:2,0:1};
      results.sort((a,b)=>{
        const ra=rankMap[a.category]??1, rb=rankMap[b.category]??1;
        if(rb!==ra) return rb-ra;
        if(a.ticketId!==b.ticketId) return a.ticketId-b.ticketId;
        return a.lineNo-b.lineNo;
      });
    } else {
      results.sort((a,b)=>{
        if(a.ticketId!==b.ticketId) return a.ticketId-b.ticketId;
        return a.lineNo-b.lineNo;
      });
    }
  }else{
    // No results yet: render plain ticket lines in ticket/line order, no highlighting
    results=[];
    tickets.forEach(t=>{
      t.lines.forEach((line,i)=>{
        results.push({ticketId:t.id,lineNo:i+1,numbers:line,category:null,hasBonus:false,matchCount:0});
      });
    });
    results.sort((a,b)=>{
      if(a.ticketId!==b.ticketId) return a.ticketId-b.ticketId;
      return a.lineNo-b.lineNo;
    });
  }

  results.forEach(r=>{
    const tr=document.createElement("tr");

    const tdLine=document.createElement("td");
    tdLine.className="lineNo";
    tdLine.textContent=lineLabel(r.ticketId, r.lineNo, totalTickets);
    tr.appendChild(tdLine);

    const tdNums=document.createElement("td");
    r.numbers.forEach(n=>{
      const s=document.createElement("span");
      s.className="num";
      // Only highlight if we have applied draw numbers
      if(lastResults.length){
        if(mainNums.includes(n)) s.classList.add("matchMain");
        if(bonus!=null && n===bonus){
          if(r.category==="5+Bonus") s.classList.add("matchBonus");
          else s.classList.add("matchBonusDim");
        }
      }
      s.textContent=String(n).padStart(2,"0");
      tdNums.appendChild(s);
    });
    tr.appendChild(tdNums);

    tbody.appendChild(tr);
  });
}

function summarize(results){
  // Show summary table (already made visible in renderResultsAndSummary)
  const counts={}; results.forEach(c=>counts[c]=(counts[c]||0)+1);
  const summaryTable=document.getElementById("summaryTable");
  summaryTable.innerHTML="";
  const thead=document.createElement("thead");
  thead.innerHTML="<tr><th>Matches</th><th>Line count</th><th>Prize</th><th>Total value</th></tr>";
  const tb=document.createElement("tbody");
  let cashTotal=0, freeTickets=0, sumCount=0;
  const order=[0,1,2,3,4,5,"5+Bonus",6];
  order.forEach(cat=>{
    const c=counts[cat]||0; sumCount+=c;
    const info=prizeTable[cat];
    if(!info) return;
    let prizeLabel=info.prize;
    let val=info.value;
    if(cat==2){
      prizeLabel="Lucky Dip";
      if(val>0){ prizeLabel+=" + £"+val.toLocaleString(); }
    }
    if(typeof val==="number" && val>0 && cat!=2){
      prizeLabel="£"+val.toLocaleString();
    }
    let totalVal="-";
    if(val!==null){
      if(val>0){ totalVal="£"+(val*c).toLocaleString(); cashTotal+=val*c; }
      else if(cat==2){ freeTickets+=c; }
    }
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${info.label||cat}</td><td>${c}</td><td>${prizeLabel}</td><td>${totalVal}</td>`;
    tb.appendChild(tr);
  });
  const tr=document.createElement("tr");
  tr.innerHTML=`<td><b>Total</b></td><td><b>${sumCount}</b></td><td></td><td><b>£${cashTotal.toLocaleString()}</b></td>`;
  tb.appendChild(tr);
  summaryTable.appendChild(thead); summaryTable.appendChild(tb);

  // Totals line text
  const totalEl=document.getElementById("totalWinnings");
  let totalText="Total winnings: ";
  if(cashTotal>0) totalText+="£"+cashTotal.toLocaleString();
  if(freeTickets>0) totalText+=(cashTotal>0?" and ":"")+freeTickets+" Free Ticket(s)";
  if(cashTotal===0 && freeTickets===0) totalText+="None";
  totalEl.textContent=totalText;
}

// ---------------- Main flow ----------------
(function init(){
  // 1) Build the top “Winning Numbers” area
  const drawParam=params.get("draw");
  if(drawParam){
    const arr=drawParam.split(/[ ,]+/).map(x=>parseInt(x,10));
    if(arr.length>=6){
      mainNums=arr.slice(0,6);
      bonus=(arr.length>=7?arr[6]:null);
      buildWinningTop(true);
      // 2) Render with results
      renderResultsAndSummary();
    }else{
      buildWinningTop(false);
      // 2) Render tickets only
      renderTable();
    }
  }else{
    // No draw param: show input balls, render tickets only
    buildWinningTop(false);
    renderTable();
  }

  // 3) Sort toggle
  document.getElementById("toggleSort").addEventListener("click",()=>{
    if(sortMode==="matches"){
      sortMode="ticket";
      document.getElementById("toggleSort").textContent="Sort by Matches";
    } else {
      sortMode="matches";
      document.getElementById("toggleSort").textContent="Sort by Ticket/Line";
    }
    renderTable();
  });

  // Hide sort/summary if we have no results yet
  if(!mainNums.length){
    document.getElementById("sortControls").style.display="none";
    document.getElementById("summary").style.display="none";
    document.getElementById("summaryTable").style.display="none";
    document.getElementById("totalWinnings").style.display="none";
  }else{
    document.getElementById("sortControls").style.display="";
    document.getElementById("summary").style.display="";
    document.getElementById("summaryTable").style.display="";
    document.getElementById("totalWinnings").style.display="";
  }
})();
</script>
</body>
</html>
