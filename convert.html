<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lotto Link Converter (to JSON)</title>
<style>
  body{font-family:system-ui,sans-serif;margin:20px;}
  textarea{width:100%;height:100px;}
  button{margin:10px 5px;padding:8px 12px;}
  #output{margin-top:15px;font-weight:bold;word-break:break-all;}
</style>
</head>
<body>
<h1>Lotto Link Converter â†’ Rich JSON</h1>
<p>Paste your old link (full URL or just query string). It will be converted to the new rich JSON format.</p>

<textarea id="input"></textarea><br>
<button id="convert">Convert</button>

<div id="output"></div>

<script>
// --- helpers ---
function parseLegacyTickets(str) {
  const out=[]; if(!str) return out;
  str.split(";").forEach(chunk=>{
    const nums=(chunk.split("-")[2]||"");
    for(let i=0;i+12<=nums.length;i+=12){
      const row=[]; for(let j=0;j<12;j+=2){ row.push(parseInt(nums.slice(i+j,i+j+2),10)); }
      if(row.length===6) out.push(row);
    }
  });
  return out;
}

// Epoch reference: F3102 = 2025-09-13 (Sat)
const baseF=3102;
const baseDate=new Date(Date.UTC(2025,8,13)); // Sept is month 8 (0-based)

function fToDate(fnum){
  const diff=fnum-baseF;
  // each increment = 1 draw = 3 or 4 days depending on Wed/Sat
  // Wed/Sat alternate every ~3 or 4 days. So just add diff*3.5 days and snap to Wed/Sat.
  const days=diff*3.5; // approximate
  const d=new Date(baseDate.getTime()+days*86400000);
  // Snap to Wed (3) or Sat (6)
  while(d.getUTCDay()!==3 && d.getUTCDay()!==6){
    d.setUTCDate(d.getUTCDate()+1);
  }
  return d.toISOString().slice(0,10);
}

// --- convert ---
document.getElementById("convert").addEventListener("click",()=>{
  let input=document.getElementById("input").value.trim();
  if(!input) return;
  input=input.replace(/^<|>$/g,"").replace(/^\"|\"$/g,"");
  let u;
  try{
    if(input.includes("http")) u=new URL(input);
    else if(input.startsWith("?")) u=new URL("http://dummy/"+input);
    else if(input.includes("=")) u=new URL("http://dummy/?"+input);
    else throw new Error("No query parameters found");
  }catch(e){ alert("Could not parse input: "+e.message); return; }

  const params=new URLSearchParams(u.search);
  const lines=parseLegacyTickets(params.get("tickets"));
  if(lines.length===0){ alert("No legacy tickets found in link."); return; }

  // get F#
  const fstr=(params.get("tickets")||"").match(/F(\d+)/);
  let drawDate=null;
  if(fstr){
    const fnum=parseInt(fstr[1],10);
    drawDate=fToDate(fnum);
  }

  const ticket={id:1, drawDates: drawDate?[drawDate]:[], lines};

  const results=[];
  if(params.get("draw")){
    const arr=params.get("draw").split(/[ ,]+/).map(x=>parseInt(x,10));
    if(arr.length===6 && params.get("bonus")) arr.push(parseInt(params.get("bonus"),10));
    if(arr.length===7){
      results.push({date: drawDate||"unknown", draw: arr, prizes: params.get("p")||("6:"+(params.get("jackpot")||""))});
    }
  }

  const data={tickets:[ticket]};
  if(results.length) data.results=results;

  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='lotto-converted.json'; a.click();
  URL.revokeObjectURL(url);

  document.getElementById("output").textContent="Exported "+lines.length+" lines to lotto-converted.json";
});
</script>
</body>
</html>