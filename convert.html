<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lotto Link Converter</title>
<style>
  body{font-family:system-ui,sans-serif;margin:20px;}
  textarea{width:100%;height:100px;}
  button{margin:10px 0;padding:8px 12px;}
  #output{margin-top:15px;font-weight:bold;word-break:break-all;}
</style>
</head>
<body>
<h1>Lotto Link Converter</h1>
<p>Paste your old link (full URL or just query string). It will be converted to the new compact format (<code>?t=...&draw=...</code>).</p>

<textarea id="input"></textarea><br>
<button id="convert">Convert</button>

<div id="output"></div>

<script>
// --- helpers ---
function base64UrlEncode(bytes) {
  let bin = "";
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

function encodeCompactTickets(lines) {
  const bits = [];
  function pushBits(val,n){
    for(let i=n-1;i>=0;i--){
      bits.push((val>>i)&1);
    }
  }
  pushBits(lines.length,16);
  lines.forEach(line => line.forEach(n => pushBits(n-1,6)));
  const bytes = new Uint8Array(Math.ceil(bits.length/8));
  bits.forEach((b,i) => {
    bytes[Math.floor(i/8)] |= b << (7-(i%8));
  });
  return base64UrlEncode(bytes);
}

function parseLegacyTickets(str) {
  const out = [];
  if(!str) return out;
  str.split(";").forEach(chunk => {
    const nums = (chunk.split("-")[2] || "");
    for(let i=0; i+12<=nums.length; i+=12) {
      const row = [];
      for(let j=0; j<12; j+=2) {
        row.push(parseInt(nums.slice(i+j,i+j+2),10));
      }
      if(row.length===6) out.push(row);
    }
  });
  return out;
}

// --- convert ---
document.getElementById("convert").addEventListener("click", () => {
  let input=document.getElementById("input").value.trim();
  if(!input) return;

  // strip surrounding <> or quotes if pasted
  input=input.replace(/^<|>$/g,"").replace(/^\"|\"$/g,"");

  // try to build URL
  let u;
  try {
    if(input.includes("http")) {
      u=new URL(input);
    } else if(input.startsWith("?")) {
      u=new URL("http://dummy/"+input);
    } else if(input.includes("=")) {
      u=new URL("http://dummy/?"+input);
    } else {
      throw new Error("No query parameters found");
    }
  } catch(e) {
    alert("Could not parse input: "+e.message);
    return;
  }

  const params=new URLSearchParams(u.search);
  const tickets=params.get("tickets");
  const lines=parseLegacyTickets(tickets);
  if(lines.length===0) {
    alert("No legacy tickets found in link.");
    return;
  }
  const compact=encodeCompactTickets(lines);

  let drawNums=[];
  if(params.get("draw")) {
    drawNums=params.get("draw").split(/[ ,]+/).map(x=>parseInt(x,10));
  }
  if(drawNums.length===6 && params.get("bonus")) {
    drawNums.push(parseInt(params.get("bonus"),10));
  }

  const newParams=new URLSearchParams();
  newParams.set("t",compact);
  if(drawNums.length===7) newParams.set("draw",drawNums.join(","));
  if(params.get("p")) newParams.set("p",params.get("p"));
  if(params.get("jackpot") && !newParams.has("p")) {
    newParams.set("p","6:"+params.get("jackpot"));
  }

  // base for new link (replace convert.html with index.html if present)
  const base=(input.includes("http") ? u.origin+u.pathname.replace(/convert\\.html$/,"index.html") : "index.html");
  const newUrl=base+"?"+newParams.toString();

  document.getElementById("output").innerHTML="New link:<br><a href=\""+newUrl+"\" target=\"_blank\">"+newUrl+"</a>";
});
</script>
</body>
</html>
