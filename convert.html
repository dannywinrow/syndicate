<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lotto Link Converter → Rich JSON</title>
<style>
  body{font-family:system-ui,sans-serif;margin:20px;}
  h1{font-size:22px;margin-bottom:4px;}
  textarea{width:100%;height:120px;}
  pre{background:#f5f5f5;padding:10px;overflow-x:auto;}
  button{padding:6px 10px;margin:6px;}
  #ticketCount{margin-top:8px;font-weight:bold;}
</style>
</head>
<body>
<h1>Lotto Link Converter → Rich JSON</h1>
<p style="color:#666;font-size:12px;">Version 0.3.5 – 2025-09-14</p>

<p>Paste a long query-string link from the old format and convert it into the new rich JSON format.</p>

<textarea id="input" placeholder="Paste old link or query here..."></textarea><br>
<button id="convert">Convert</button>
<button id="exportJson" disabled>Export JSON</button>

<div id="ticketCount"></div>
<pre id="output"></pre>

<script>
// --- default prize tiers ---
const defaultPrizes = {2:0,3:30,4:140,5:1750,"5b":1000000,6:7500000};

// --- decode tickets from compact form ---
function base64UrlDecode(str){
  str=str.replace(/-/g,'+').replace(/_/g,'/');
  while(str.length%4) str+='=';
  return Uint8Array.from(atob(str),c=>c.charCodeAt(0));
}
function decodeCompactTickets(compact){
  const bytes=base64UrlDecode(compact);
  const bits=[]; bytes.forEach(b=>{for(let i=7;i>=0;i--) bits.push((b>>i)&1);});
  let idx=0; function readBits(n){let v=0; for(let i=0;i<n;i++){v=(v<<1)|bits[idx++];} return v;}
  const count=readBits(16);
  const lines=[];
  for(let i=0;i<count;i++){
    const row=[]; for(let j=0;j<6;j++) row.push(readBits(6)+1);
    lines.push(row);
  }
  return lines;
}

// --- handle conversion ---
let lastData=null;
document.getElementById('convert').addEventListener('click',()=>{
  const raw=document.getElementById('input').value.trim();
  if(!raw){ alert('Paste a link first'); return; }

  // autodetect query part
  let qs="";
  try{
    if(raw.startsWith('http')) qs=new URL(raw).search;
    else if(raw.startsWith('?')) qs=raw;
    else qs="?"+raw;
  }catch(e){ qs="?"+raw; }
  const params=new URLSearchParams(qs);

  const compact=params.get('t');
  if(!compact){ alert('No tickets found in this link'); return; }
  const lines=decodeCompactTickets(compact);

  const draw=params.get('draw')||null;
  const prizes=params.get('p')||null;

  // Build tickets[]
  const tickets=[{id:1, drawDates:[draw||'unknown'], lines}];

  // Build results[] if draw present
  let results=[];
  if(draw){
    const arr=draw.split(/[ ,]+/).map(x=>parseInt(x,10));
    if(arr.length>=7){
      const pObj={...defaultPrizes};
      if(prizes){
        prizes.split(';').forEach(p=>{
          const [k,v]=p.split(':'); pObj[k]=parseInt(v,10);
        });
      }
      results=[{date:draw, draw:arr, prizes:Object.entries(pObj).map(([k,v])=>`${k}:${v}`).join(';')}];
    }
  }

  const data={tickets, results};
  lastData=data;

  document.getElementById('output').textContent=JSON.stringify(data,null,2);
  document.getElementById('ticketCount').textContent="Ticket count: "+tickets.length+" (lines: "+lines.length+")";
  document.getElementById('exportJson').disabled=false;
});

// --- export JSON ---
document.getElementById('exportJson').addEventListener('click',()=>{
  if(!lastData) return;
  const blob=new Blob([JSON.stringify(lastData,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='lotto-converted.json'; a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
