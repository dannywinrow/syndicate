<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lotto Syndicate Admin</title>
<style>
  body{font-family:system-ui,sans-serif;margin:20px;}
  h1{font-size:22px;margin-bottom:10px;}
  #reader{width:320px;margin:auto;}
  table{border-collapse:collapse;margin-top:15px;width:100%;}
  th,td{border:1px solid #ccc;padding:6px;text-align:left;}
  .controls{margin-top:15px;}
  input,button{padding:6px 10px;margin:4px;}
  #outputLink{margin-top:15px;word-break:break-all;font-weight:bold;}
  #lineCount{margin-top:10px;font-weight:bold;}
</style>
</head>
<body>
<h1>Lotto Syndicate â€“ Admin Page</h1>

<p>Scan ticket QR codes using your device camera or upload an image. Each scan will be added below. Then add winning numbers (7 numbers including bonus) and optional prizes. Generate a shareable link for your group.</p>

<div id="reader"></div>
<p>Or upload an image of a QR code:</p>
<input type="file" id="fileInput" accept="image/*">

<h3>Scanned Tickets</h3>
<table id="ticketTable">
  <thead><tr><th>#</th><th>Raw QR</th><th>Compact Format</th><th>Remove</th></tr></thead>
  <tbody></tbody>
</table>
<div id="lineCount"></div>

<div class="controls">
  <label>Winning numbers (7, last is bonus): <input id="drawInput" size="25" placeholder="01 09 18 27 38 42 11"></label><br>
  <label>Prizes: 2=<input id="p2" size="4" placeholder="0"> 3=<input id="p3" size="4" placeholder="30"> 4=<input id="p4" size="4" placeholder="140"> 5=<input id="p5" size="6" placeholder="1750"> 5b=<input id="p5b" size="8" placeholder="1000000"> 6=<input id="p6" size="8" placeholder="7500000"></label><br>
  <button id="generate" type="button">Generate Shareable Link</button>
  <button id="clear" type="button">Clear All</button>
</div>

<div id="outputLink"></div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let tickets = JSON.parse(localStorage.getItem('adminTickets')||'[]');
const html5QrCode = new Html5Qrcode('reader');

function persist(){ localStorage.setItem('adminTickets', JSON.stringify(tickets)); }

function countLines(){
  let total=0;
  tickets.forEach(t=>{
    const m=t.compact.match(/S(\d+)/);
    if(m){ total+=m[1].length/12; }
  });
  document.getElementById('lineCount').textContent = 'Total lines scanned: '+total;
}

function addTicket(raw){
  if(!raw || raw==='0') return;
  let compact = raw;
  try{
    const f = (raw.match(/F(\d+)/)||[])[1];
    const d = (raw.match(/D(\d+)/)||[])[1];
    const s = (raw.match(/S(\d+)/)||[])[1];
    if(f && d && s && s.length%12===0){
      compact = `F${f}-D${d}-${s}`;
    } else return;
  }catch(e){ return; }
  tickets.push({raw, compact});
  persist();
  renderTickets();
}

function renderTickets(){
  const tb=document.querySelector('#ticketTable tbody');
  tb.innerHTML='';
  tickets.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${t.raw}</td><td>${t.compact}</td><td><button type="button" onclick="removeTicket(${i})">Remove</button></td>`;
    tb.appendChild(tr);
  });
  countLines();
}

function removeTicket(i){
  tickets.splice(i,1);
  persist();
  renderTickets();
}

document.getElementById('clear').addEventListener('click',()=>{
  tickets=[]; persist(); renderTickets();
});

function base64UrlEncode(bytes){
  let bin="";
  bytes.forEach(b=> bin+=String.fromCharCode(b));
  let str=btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return str;
}

function encodeCompactTickets(){
  let lines=[];
  tickets.forEach(t=>{
    const m=t.compact.match(/S(\d+)/);
    if(m){
      const s=m[1];
      for(let i=0;i+12<=s.length;i+=12){
        const arr=[];
        for(let j=0;j<12;j+=2){
          arr.push(parseInt(s.slice(i+j,i+j+2),10));
        }
        lines.push(arr);
      }
    }
  });
  const lineCount=lines.length;
  const bits=[];
  function pushBits(val,n){
    for(let i=n-1;i>=0;i--) bits.push((val>>i)&1);
  }
  pushBits(lineCount,16);
  lines.forEach(line=> line.forEach(n=> pushBits(n-1,6)));
  const bytes=new Uint8Array(Math.ceil(bits.length/8));
  bits.forEach((b,i)=>{ bytes[Math.floor(i/8)]|=b<<(7-(i%8)); });
  return base64UrlEncode(bytes);
}

document.getElementById('generate').addEventListener('click',()=>{
  if(!tickets.length){ alert('Scan some tickets first!'); return; }
  const params=new URLSearchParams();

  // Draw numbers (7, last is bonus)
  const draw=document.getElementById('drawInput').value.trim();
  if(draw) params.set('draw',draw);

  // Prizes
  const prizeStr=[];
  const map={p2:'2',p3:'3',p4:'4',p5:'5',p5b:'5b',p6:'6'};
  for(const id in map){
    const v=document.getElementById(id).value.trim();
    if(v) prizeStr.push(map[id]+":"+v);
  }
  if(prizeStr.length) params.set('p',prizeStr.join(';'));

  // Compact encoding
  const compact=encodeCompactTickets();
  params.set('t',compact);

  const base = location.origin + location.pathname.replace(/admin\.html$/, '');
  const url = base + (base.endsWith('/') ? '' : '/') + 'index.html' + '?' + params.toString();
  document.getElementById('outputLink').innerHTML = `Share this link:<br><a href="${url}" target="_blank">${url}</a>`;
});

// --- QR Scanner ---
function onScanSuccess(decodedText){
  if(tickets.find(t=>t.raw===decodedText)) return;
  addTicket(decodedText);
}

Html5Qrcode.getCameras().then(devices => {
  if(devices && devices.length) {
    html5QrCode.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 }, onScanSuccess);
  }
}).catch(err=>console.error(err));

// --- File upload fallback ---
document.getElementById('fileInput').addEventListener('change', e => {
  if (e.target.files.length === 0) return;
  const file = e.target.files[0];
  html5QrCode.scanFile(file, true)
    .then(decodedText => { if(!tickets.find(t=>t.raw===decodedText)) addTicket(decodedText); })
    .catch(err => alert('QR scan failed: ' + err));
});

// preload from query
const params=new URLSearchParams(location.search);
if(params.get('tickets')){
  params.get('tickets').split(';').forEach(raw=> addTicket(raw));
}

renderTickets();
</script>
</body>
</html>
